info.app:
  name: HMPPS E-Supervision
  version: 1.0

api:
  base:
    url:
      manage-users-api: ${MANAGE_USERS_API}
      ndilius-api: ${NDILIUS_API_URL:https://esupervision-and-delius-dev.hmpps.service.justice.gov.uk}

app:
  hostedAt: ${HOSTED_AT}
  # how long should the presigned S3 URLs be valid for?
  upload-ttl-minutes: 10
  scheduling:
    checkin-notification:
      # How long, starting from dueDate, do we accept checkin submissions.
      # Afterward the checkin's status is updated to EXPIRED.
      window: 72h
      cron: "0 0 9 * * *"
      # cron: "0 */15 * * * *"  # Development schedule (every 15 minutes)
    offender-checkin-expiry:
      cron: "0 15 9 * * *"
      #cron: "0 0 1,10 * * *"  # Production schedule (1 AM and 10 AM daily)
    offender-checkin-notification-status:
      cron: "0 30 * * * *"
    generic-notification-status:
      cron: "0 0 15 * * *"
    # V2 Scheduled Jobs (core features - always enabled)
    v2-checkin-creation:
      cron: "0 0 9 * * *"  # Every day at 9 AM (matches V1 timing)
    v2-checkin-expiry:
      cron: "0 15 9 * * *"  # Every day at 9:15 AM (matches V1 timing)
      grace-period-days: 3

spring:
  application:
    name: esupervision-api
  codec:
    max-in-memory-size: 10MB
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=500, expireAfterWrite=6h

  jackson:
    date-format: "yyyy-MM-dd HH:mm:ss"
    serialization:
      WRITE_DATES_AS_TIMESTAMPS: false

  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: ${hmpps-auth.url}/.well-known/jwks.json

      client:
        provider:
          hmpps-auth:
            token-uri: ${hmpps-auth.url}/oauth/token

        registration:
          manage-users-api:
            provider: hmpps-auth
            client-id: ${API_CLIENT_ID}
            client-secret: ${API_CLIENT_SECRET}
            authorization-grant-type: client_credentials
            scope: read

          ndilius-api:
            provider: hmpps-auth
            client-id: ${API_CLIENT_ID}
            client-secret: ${API_CLIENT_SECRET}
            authorization-grant-type: client_credentials
            scope: read

  datasource:
    url: jdbc:postgresql://${POSTGRES_ENDPOINT}/${POSTGRES_DATABASE}
    driver-class-name: org.postgresql.Driver
    username: ${POSTGRES_USERNAME}
    password: ${POSTGRES_PASSWORD}
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      idle-timeout: 60000
      connection-timeout: 30000
      pool-name: HikariPool-esupervision

  liquibase:
    change-log: classpath:/db/changelog/db.changelog-master.yaml

  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    show-sql: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
        dialect: org.hibernate.dialect.PostgreSQLDialect
        type:
          preferred_duration_jdbc_type: INTERVAL_SECOND

server:
  port: 8080
  servlet:
    context-path: /
  forward-headers-strategy: native
  tomcat:
    remoteip:
      remote-ip-header: x-forwarded-for
      protocol-header: x-forwarded-proto
      internal-proxies: 10\.\d{1,3}\.\d{1,3}\.\d{1,3}|192\.168\.\d{1,3}\.\d{1,3}|169\.254\.\d{1,3}\.\d{1,3}|127\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.1[6-9]{1}\.\d{1,3}\.\d{1,3}|172\.2[0-9]{1}\.\d{1,3}\.\d{1,3}|172\.3[0-1]{1}\.\d{1,3}\.\d{1,3}|0:0:0:0:0:0:0:1|::1|100\.6[4-9]\.\d{1,3}\.\d{1,3}|100\.[7-9][0-9]{1}\.\d{1,3}\.\d{1,3}|100\.1[0-1][0-9]{1}\.\d{1,3}\.\d{1,3}|100\.12[0-7]\.\d{1,3}\.\d{1,3}
  shutdown: graceful
  error:
    include-message: always

management:
  endpoints:
    web:
      base-path: /
      exposure:
        include: 'info, health'
  endpoint:
    health:
      cache:
        time-to-live: 2000ms
      show-components: always
      show-details: always
      probes:
        enabled: true
    info:
      cache:
        time-to-live: 2000ms

aws:
  region-name: eu-west-2
  s3:
    image-uploads: ${S3_DATA_BUCKET_NAME}
    video-uploads: ${S3_DATA_BUCKET_NAME}

notify:
  apiKey: ${NOTIFY_API_KEY}
  channels:
    offender-sms-enabled: true
    offender-email-enabled: true
    practitioner-sms-enabled: false
    practitioner-email-enabled: true
  sms-templates:
    POP_CHECKIN_INVITE: 41f78d9f-95d1-45c4-bad2-ec53fcddc017
    PRACTITIONER_CHECKIN_SUBMITTED: 6923e8c1-543c-44b9-bcc4-766ce4bb6a23
    PRACTITIONER_CHECKIN_MISSED: c1bb3afc-31ce-4e83-a97f-b6e5d686d702
    PRACTITIONER_INVITE_ISSUE_GENERIC: 0bef5b11-9261-4c98-9580-92f2f3ecd27d
    POP_REGISTRATION_CONFIRMATION: 35274201-ecef-493b-b4e1-86e60d071142
    POP_SUBMISSION_CONFIRMATION: 80695bae-3917-436a-824b-c61ce04ca4a3
    POP_CHECKINS_STOPPED: f1280bf6-4434-48e4-b827-9164b54bc6b8
  email-templates:
    POP_CHECKIN_INVITE: 3806414e-083e-410e-825a-76e2c72bbd8b
    PRACTITIONER_CHECKIN_SUBMITTED: 42e08740-b7ca-4457-9a61-136ee365cee5
    PRACTITIONER_CHECKIN_MISSED: a65ff803-22f5-4f8b-947e-10535ad24bc5
    PRACTITIONER_INVITE_ISSUE_GENERIC: 6054dbfb-5d43-4d23-8ecf-138216f8b629
    POP_REGISTRATION_CONFIRMATION: 7e63c01c-05df-4b2c-a77c-57d2412793a1
    POP_SUBMISSION_CONFIRMATION: 8558a963-0d76-4ad5-82d3-3eb536c76563
    POP_CHECKINS_STOPPED: 5ea87cee-4772-4496-87d3-099327bd7dee

rekognition:
  face-similarity:
    # minimum accepted value that qualifies a "match"
    threshold: 90.0
  region: ${REKOG_AWS_REGION}
  role_arn: ${REKOG_ROLE_ARN}
  role_session_name: ${REKOG_ROLE_SESSION_NAME}
  s3_bucket_name: ${REKOG_S3_DATA_BUCKET}
  max-concurrency: 10
  read-timeout-seconds: 20

resilience4j:
  circuitbreaker:
    instances:
      ndiliusApi:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
        wait-duration-in-open-state: 60s
        failure-rate-threshold: 50
        slow-call-rate-threshold: 80
        slow-call-duration-threshold: 3s
        record-exceptions:
          - org.springframework.web.reactive.function.client.WebClientRequestException
          - org.springframework.web.reactive.function.client.WebClientResponseException.InternalServerError
          - org.springframework.web.reactive.function.client.WebClientResponseException.BadGateway
          - org.springframework.web.reactive.function.client.WebClientResponseException.ServiceUnavailable
          - org.springframework.web.reactive.function.client.WebClientResponseException.GatewayTimeout
        ignore-exceptions:
          - org.springframework.web.reactive.function.client.WebClientResponseException.BadRequest
          - org.springframework.web.reactive.function.client.WebClientResponseException.NotFound
          - org.springframework.web.reactive.function.client.WebClientResponseException.Unauthorized
          - org.springframework.web.reactive.function.client.WebClientResponseException.Forbidden

      govNotify:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
        wait-duration-in-open-state: 60s
        failure-rate-threshold: 50
        slow-call-rate-threshold: 80
        slow-call-duration-threshold: 5s
        record-exceptions:
          - uk.gov.service.notify.NotificationClientException

      awsS3:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true
        wait-duration-in-open-state: 30s
        failure-rate-threshold: 70
        slow-call-rate-threshold: 90
        slow-call-duration-threshold: 10s
        record-exceptions:
          - software.amazon.awssdk.core.exception.SdkException
          - software.amazon.awssdk.services.s3.model.S3Exception

      awsRekognition:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true
        wait-duration-in-open-state: 30s
        failure-rate-threshold: 70
        slow-call-rate-threshold: 90
        slow-call-duration-threshold: 8s
        record-exceptions:
          - software.amazon.awssdk.services.rekognition.model.RekognitionException
        ignore-exceptions:
          - software.amazon.awssdk.services.rekognition.model.InvalidParameterException

  retry:
    instances:
      ndiliusApi:
        max-attempts: 3
        wait-duration: 500ms
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - org.springframework.web.reactive.function.client.WebClientRequestException
          - org.springframework.web.reactive.function.client.WebClientResponseException.InternalServerError
          - org.springframework.web.reactive.function.client.WebClientResponseException.BadGateway
          - org.springframework.web.reactive.function.client.WebClientResponseException.ServiceUnavailable
          - org.springframework.web.reactive.function.client.WebClientResponseException.GatewayTimeout
        ignore-exceptions:
          - org.springframework.web.reactive.function.client.WebClientResponseException.BadRequest
          - org.springframework.web.reactive.function.client.WebClientResponseException.NotFound
          - org.springframework.web.reactive.function.client.WebClientResponseException.Unauthorized
          - org.springframework.web.reactive.function.client.WebClientResponseException.Forbidden

      govNotify:
        max-attempts: 3
        wait-duration: 1000ms
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - uk.gov.service.notify.NotificationClientException

      awsS3:
        max-attempts: 2
        wait-duration: 200ms
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - software.amazon.awssdk.core.exception.SdkException
          - software.amazon.awssdk.services.s3.model.S3Exception

      awsRekognition:
        max-attempts: 2
        wait-duration: 300ms
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - software.amazon.awssdk.services.rekognition.model.RekognitionException
        ignore-exceptions:
          - software.amazon.awssdk.services.rekognition.model.InvalidParameterException

  timelimiter:
    instances:
      ndiliusApi:
        timeout-duration: 5s
        cancel-running-future: true

      govNotify:
        timeout-duration: 10s
        cancel-running-future: true

      awsS3:
        timeout-duration: 15s
        cancel-running-future: true

      awsRekognition:
        timeout-duration: 30s
        cancel-running-future: true
